# Feature 0001: Port Web Application to React Native/Expo Mobile

## Brief Description

Port the ZKJ - Controle de Qualidade horse breeding management web application from React web (Vite + IndexedDB) to React Native/Expo mobile application. The migration maintains all existing functionality while adapting to mobile platform APIs: replacing IndexedDB with Expo SQLite, HTML components with React Native components, TailwindCSS with StyleSheet, and HTML5 File APIs with Expo file system APIs.

## Files to Modify

### Data Layer
- `hooks/useLocalStorage.ts` - Complete rewrite to use Expo SQLite instead of IndexedDB
- `types.ts` - No changes (types remain compatible)

### UI Components (All require React Native conversion)
- `components/Header.tsx` - Replace HTML elements with View, Text, Pressable, TouchableOpacity
- `components/HorseList.tsx` - Replace div with View, use FlatList or ScrollView instead of map
- `components/HorseCard.tsx` - Replace div/img with View/Image, onClick with onPress
- `components/HorseDetail.tsx` - Replace HTML elements with React Native components
- `components/HorseForm.tsx` - Replace form inputs with TextInput, Select with Picker/Modal picker
- `components/MatingForm.tsx` - Replace form elements with React Native equivalents
- `components/FloatingActionButton.tsx` - Replace button with Pressable/TouchableOpacity, adjust positioning
- `components/Icons.tsx` - Keep SVG structure but ensure React Native SVG compatibility

### Core Application
- `App.tsx` - Replace view state machine with React Navigation, replace window.confirm/alert with Alert API, replace handleExport/handleImport file operations
- `index.tsx` - Replace ReactDOM.createRoot with React Native AppRegistry registration
- `utils/fileUtils.ts` - Rewrite fileToBase64 to work with Expo file URIs and base64 encoding

### New Files to Create
- `app.json` - Expo configuration file with required plugins and permissions
- `package.json` - Update dependencies (remove Vite, add Expo, React Navigation, Expo SQLite, Expo Image Picker, Expo Document Picker, Expo Sharing, Expo File System)
- `App.tsx` (new root) - Navigation container setup with React Navigation
- `navigation/AppNavigator.tsx` - Stack navigator configuration
- `screens/HorseListScreen.tsx` - Convert HorseList component to screen
- `screens/HorseDetailScreen.tsx` - Convert HorseDetail component to screen
- `screens/HorseFormScreen.tsx` - Convert HorseForm component to screen
- `screens/MatingFormScreen.tsx` - Convert MatingForm component to screen
- `hooks/useExpoStorage.ts` - New storage hook using Expo SQLite
- `utils/imageUtils.ts` - New utility for image handling with Expo Image Picker
- `utils/exportUtils.ts` - New utility for file export using Expo File System and Sharing
- `utils/importUtils.ts` - New utility for file import using Expo Document Picker
- `styles/` - Directory for StyleSheet definitions (or inline styles per component)

## Implementation Details

### Phase 1: Data Layer Migration

**Algorithm: IndexedDB to Expo SQLite Migration**

1. **Storage Hook Replacement (`hooks/useLocalStorage.ts` → `hooks/useExpoStorage.ts`)**:
   - Remove `idb` import and `openDB` calls
   - Import `expo-sqlite` and use `SQLiteProvider` context or direct database access
   - Replace `initDB()` function:
     - Use `expo-sqlite` to open/create database file
     - Create `horses` table with schema matching Horse interface (id as primary key, all fields as TEXT/JSON)
   - Replace `useIndexedDB` hook:
     - `useState` for horses array remains the same
     - `useEffect` fetch: Replace `db.getAll(STORE_NAME)` with SQL `SELECT * FROM horses`
     - `addHorse`: Replace `db.add()` with SQL `INSERT INTO horses VALUES (...)` using parameterized queries
     - `updateHorse`: Replace `db.put()` with SQL `UPDATE horses SET ... WHERE id = ?`
     - `deleteHorse`: Replace `db.delete()` with SQL `DELETE FROM horses WHERE id = ?`
     - `importData`: Replace transaction with SQL transaction (BEGIN, DELETE FROM horses, multiple INSERTs, COMMIT)
   - Maintain same hook interface (`{ horses, addHorse, updateHorse, deleteHorse, importData }`) for component compatibility

2. **Type Compatibility**:
   - `types.ts` requires no changes - Horse, MatingRecord, Gender enum remain compatible
   - SQLite stores JSON as TEXT, so serialize/deserialize matingHistory array when reading/writing

3. **Database Schema**:
   - Table: `horses`
   - Columns: `id` (TEXT PRIMARY KEY), `name` (TEXT), `birthDate` (TEXT), `gender` (TEXT), `father` (TEXT), `mother` (TEXT), `chip` (TEXT), `registro` (TEXT), `picture` (TEXT), `matingHistory` (TEXT as JSON), `birthPlace` (TEXT), `deliveryDetails` (TEXT)
   - Migration: On first app launch, create table if not exists

### Phase 2A: UI Components Migration

**Algorithm: HTML to React Native Component Conversion**

1. **Header Component (`components/Header.tsx`)**:
   - Replace `<header>` with `<View style={styles.header}>`
   - Replace `<button>` with `<Pressable>` or `<TouchableOpacity>` with `onPress` handlers
   - Replace `<h1>` with `<Text style={styles.title}>`
   - Replace `<input type="file">` with Expo Document Picker trigger (see Phase 2C)
   - Convert TailwindCSS classes to StyleSheet.create object
   - Remove `importInputRef` and hidden input pattern - use Document Picker directly

2. **HorseList Component (`components/HorseList.tsx`)**:
   - Replace `<div>` with `<View>` or `<ScrollView>`
   - Replace `horses.map()` with `<FlatList>` for performance (data prop, renderItem, keyExtractor)
   - Keep FloatingActionButton component (will be migrated separately)
   - Convert TailwindCSS spacing/padding to StyleSheet

3. **HorseCard Component (`components/HorseCard.tsx`)**:
   - Replace `<div onClick={onClick}>` with `<Pressable onPress={onClick}>` or `<TouchableOpacity onPress={onClick}>`
   - Replace `<img>` with `<Image source={{ uri: horse.picture }}>` handling base64 data URIs
   - Convert all TailwindCSS classes to StyleSheet
   - Maintain hover effects using Pressable's pressed state styling

4. **HorseDetail Component (`components/HorseDetail.tsx`)**:
   - Replace `<div>` with `<ScrollView>` for scrollable content
   - Replace `<img>` with `<Image>` for horse picture
   - Replace `<h2>`, `<h3>`, `<p>`, `<span>` with `<Text>` with appropriate fontSize/weight styles
   - Replace `<button>` with `<Pressable>` or `<TouchableOpacity>`
   - Replace fixed bottom buttons with `<View style={styles.fixedBottom}>` or use SafeAreaView
   - Convert grid layout (TailwindCSS `grid-cols-2`) to Flexbox with `flexDirection: 'row'` and `flex: 1`

5. **HorseForm Component (`components/HorseForm.tsx`)**:
   - Replace `<form>` with `<View>` and handle submit with `onPress` on button
   - Replace `<input type="text">` with `<TextInput>` with `value`, `onChangeText`, `placeholder` props
   - Replace `<input type="date">` with date picker library (e.g., `@react-native-community/datetimepicker`) or custom modal
   - Replace `<select>` with `<Picker>` from `@react-native-picker/picker` or custom modal picker
   - Replace `<textarea>` with `<TextInput multiline numberOfLines={3}>`
   - Replace `<input type="file">` for image with Expo Image Picker (see Phase 2C)
   - Replace `<img>` preview with `<Image>` component
   - Convert all TailwindCSS to StyleSheet
   - Remove `e.preventDefault()` - not needed in React Native

6. **MatingForm Component (`components/MatingForm.tsx`)**:
   - Apply same conversion patterns as HorseForm
   - Replace `<select>` for male horses with `<Picker>` or modal picker
   - Replace `<input type="date">` with date picker

7. **FloatingActionButton Component (`components/FloatingActionButton.tsx`)**:
   - Replace `<button>` with `<Pressable>` or `<TouchableOpacity>`
   - Replace `fixed bottom-6 right-6` positioning with `position: 'absolute'`, `bottom: 24`, `right: 24`
   - Ensure it's within a container with `position: 'relative'` or use absolute positioning within parent View
   - Convert TailwindCSS to StyleSheet

8. **Icons Component (`components/Icons.tsx`)**:
   - Verify SVG compatibility with `react-native-svg`
   - Ensure all SVG paths use compatible props (may need minor adjustments)
   - Keep className prop but convert to style prop for React Native

### Phase 2B: Navigation Migration

**Algorithm: View State Machine to React Navigation**

1. **Navigation Setup (`navigation/AppNavigator.tsx`)**:
   - Install `@react-navigation/native` and `@react-navigation/native-stack`
   - Install `react-native-screens` and `react-native-safe-area-context`
   - Create stack navigator using `createNativeStackNavigator()`
   - Define screens: 'HorseList', 'HorseDetail', 'HorseForm', 'MatingForm'
   - Configure screen options (headers, back button behavior)

2. **App.tsx Refactor**:
   - Remove `View` type and `view` state
   - Remove `selectedHorseId` state (pass via navigation params)
   - Remove `renderContent()` function
   - Remove `getTitle()` function (use navigation header titles)
   - Wrap app with `NavigationContainer` and `AppNavigator`
   - Replace `setView()` calls with `navigation.navigate()`:
     - `setView('LIST')` → `navigation.navigate('HorseList')`
     - `setView('DETAIL')` → `navigation.navigate('HorseDetail', { horseId })`
     - `setView('ADD')` → `navigation.navigate('HorseForm')`
     - `setView('EDIT')` → `navigation.navigate('HorseForm', { horseId, mode: 'edit' })`
     - `setView('MATE')` → `navigation.navigate('MatingForm', { femaleHorseId })`
   - Replace `window.confirm()` in `handleDeleteHorse` with `Alert.alert()` with buttons array
   - Replace `alert()` calls with `Alert.alert()`

3. **Screen Components**:
   - Convert each view component to screen component
   - Use `useNavigation()` hook to access navigation object
   - Use `useRoute()` hook to access route params (horseId, mode, etc.)
   - Pass navigation callbacks as props to child components

4. **Header Integration**:
   - Use React Navigation's header options or custom header component
   - Back button handled automatically by stack navigator
   - Import/Export buttons in header use handlers from App context or navigation params

### Phase 2C: File Operations Migration

**Algorithm: HTML5 File API to Expo File System APIs**

1. **Image Upload (`utils/imageUtils.ts` - new file)**:
   - Replace `fileToBase64()` from `utils/fileUtils.ts`
   - Import `expo-image-picker`
   - Request camera/media library permissions using `ImagePicker.requestMediaLibraryPermissionsAsync()` and `ImagePicker.requestCameraPermissionsAsync()`
   - Create `pickImageAsync()` function:
     - Call `ImagePicker.launchImageLibraryAsync()` or `ImagePicker.launchCameraAsync()` with options (allowsEditing, quality, mediaTypes)
     - Handle result: if `!result.canceled`, access `result.assets[0].uri`
     - Convert URI to base64: Use `expo-file-system` `FileSystem.readAsStringAsync(uri, { encoding: FileSystem.EncodingType.Base64 })` and prepend data URI prefix
     - Return base64 string compatible with existing `picture` field in Horse interface
   - Update `HorseForm.tsx` to use `pickImageAsync()` instead of file input onChange handler

2. **Data Export (`utils/exportUtils.ts` - new file)**:
   - Replace `handleExport()` in `App.tsx`
   - Import `expo-file-system` and `expo-sharing`
   - Create `exportHorsesData()` function:
     - Accept horses array as parameter
     - Serialize to JSON: `JSON.stringify(horses, null, 2)`
     - Get document directory: `FileSystem.documentDirectory`
     - Write file: `FileSystem.writeAsStringAsync(fileUri, jsonString, { encoding: FileSystem.EncodingType.UTF8 })`
     - Generate filename: `haras_backup_${date}.json`
     - Share file: `Share.shareAsync({ uri: fileUri, mimeType: 'application/json' })` to allow user to save/share
   - Replace DOM link creation/download pattern with Expo Sharing API

3. **Data Import (`utils/importUtils.ts` - new file)**:
   - Replace `handleImport()` in `App.tsx`
   - Import `expo-document-picker`
   - Create `importHorsesData()` function:
     - Call `DocumentPicker.getDocumentAsync({ type: 'application/json', copyToCacheDirectory: true })`
     - Handle result: if `!result.canceled`, access `result.assets[0].uri`
     - Read file: `FileSystem.readAsStringAsync(uri, { encoding: FileSystem.EncodingType.UTF8 })`
     - Parse JSON: `JSON.parse(content)`
     - Validate: Check if array and has valid Horse structure (id field present)
     - Return parsed horses array or throw error
   - Update `App.tsx` to use `Alert.alert()` for confirmation dialog instead of `window.confirm()`
   - Call `importData()` hook method with parsed array

4. **File Utils Cleanup (`utils/fileUtils.ts`)**:
   - Remove `fileToBase64()` function (replaced by imageUtils)
   - File can be deleted or kept for web compatibility if needed

### Configuration

1. **app.json Creation**:
   - Configure Expo app name, slug, version
   - Add iOS bundle identifier and Android package name
   - Configure permissions: camera, photo library, file system access
   - Add plugins: `expo-image-picker`, `expo-document-picker`
   - Configure iOS info.plist permissions (NSPhotoLibraryUsageDescription, NSCameraUsageDescription)

2. **package.json Updates**:
   - Remove: `vite`, `@vitejs/plugin-react`, `react-dom`, `idb`
   - Add: `expo`, `react-native`, `@react-navigation/native`, `@react-navigation/native-stack`, `react-native-screens`, `react-native-safe-area-context`, `expo-sqlite`, `expo-image-picker`, `expo-document-picker`, `expo-file-system`, `expo-sharing`, `react-native-svg`, `@react-native-picker/picker` (or alternative)

3. **Entry Point (`index.tsx`)**:
   - Remove ReactDOM rendering
   - Register app: `AppRegistry.registerComponent('ZKJControle', () => App)`
   - Import App component

## Key Algorithm: Data Serialization for SQLite

When storing Horse objects in SQLite:
1. Serialize `matingHistory` array to JSON string before INSERT: `JSON.stringify(horse.matingHistory)`
2. When reading from SQLite, deserialize `matingHistory` field: `JSON.parse(row.matingHistory || '[]')`
3. Handle null/undefined optional fields by storing as empty strings or NULL in SQLite
4. Maintain base64 picture strings as-is (stored as TEXT in SQLite)

## Key Algorithm: Image URI Handling

For images displayed in React Native:
1. If `horse.picture` starts with `data:image/`, use directly as URI source for `<Image source={{ uri: horse.picture }}>`
2. React Native Image component supports data URIs natively
3. For image picker results, convert file URI to base64 only when storing in database (to maintain compatibility with existing data structure)
